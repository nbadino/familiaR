---
title: "FamiliaR with Dynamics"
output: 
  flexdashboard::flex_dashboard:
    orientation: column
    social: menu
    source_code: embed
    theme: spacelab
runtime: shiny
---

<style>

.form-control {
    width: 90%;
    }

</style>


```{r global, include=FALSE}
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(datasets)
library(ggplot2)
library(bslib)
library(shinycssloaders)
options(shiny.maxRequestSize = 30*1024^2)
data(faithful)
Solow1 <- function(s,k,a){
  y <- s*k^a
  return <- y
}
Solow2 <- function(d,k){
  y <- d*k+k^-1
}
solow_de <- function(t,y,parameters){
  s <- parameters[1]
  a <- parameters[2]
  del <- parameters[3]
  #k <- parameters[4]
  rhs <- s*y^a
  lhs <- del*y+(1/y)
  dy = rhs-lhs
  list(dy)
}
goodwin2<-function(t, state, parameters) {
  with(as.list(c(state, parameters)),{
    dV <- (a-b*U)*V
    dU <- (-c+d*V)*U
    dQ <- ((1-U)/sigma)*Q
    list(c(dV, dU, dQ))})}
goodwin <- function(t, y, parameters) {
  x <- y[1]
  y <- y[2]
  sigma <- parameters[1]
  alpha <- parameters[2]
  beta <- parameters[3]
  gamma <- parameters[4]
  rho <- parameters[5]
  A <- 1/sigma - alpha - beta
  B <- 1/sigma
  C <- gamma+alpha
  D <- rho
  dy <- numeric(2)
  dy[1] <- A*x - B*x*y
  dy[2] <- C*x*y - D*y
  list(dy)
}
ramsey <- function(t, y, parameters) {
  x <- y[1] #capital dc/dt
  y <- y[2] #consumption dk/dt
  theta <- parameters[1]
  rho <- parameters[2]
  delta <- parameters[3]
  alpha <- parameters[4]
  dy <- numeric(2)
  r <- alpha*x^(alpha-1)
  dy[1] <- x^alpha-y-delta*x
  dy[2] <- (y*(r-theta-delta))/delta
  list(dy)
}
```

Dynamics {data-navmenu='Models' data-icon='ion-levels'}
=======================================================================

Column {.sidebar}
-----------------------------------------------------------------------

Select your model and the value of each parameters.

```{r}
selectInput("model", label = "Economic Model:",
            choices = c("Solow", "Ramsey", "OLG", "Goodwin"), selected = "Solow")
conditionalPanel("input.model == 'Solow'",
                 sliderInput("k", label = "Chart length (k):", min = 1, max = 100, value = 20, step = 1),
                 sliderInput("s", label = "Saving rate:", min = 0, max = 1, value =0.2, step = 0.01),
                 sliderInput("a", label = "Elasticty:", min = 0, max = 1, value =0.3, step = 0.01),
                 sliderInput("d", label = "Depreciation:", min = 0, max = 1, value =0.02, step = 0.01),
                 sliderInput("n", label = "Population growth rate:", min = 0, max = 1, value =0.5, step = 0.01),
                 sliderInput("t", label = "Time", min = 0, max = 100, value =20, step = 5),
                 numericInput('k0', 'Initial capital, k0:', 3, min=0.5, max=200)
                 
)
conditionalPanel("input.model == 'Ramsey'",
                 sliderInput("t", label = "Time", min = 0, max = 200, value = 50, step = 5),
                 sliderInput("c", label = "Consumption, dc/dt",min = 0, max = 5, value = 3, step = 0.05),
                 sliderInput("k", label = "Capital, dk/dt", min = 0, max = 50, value = 30, step = 0.5),
                 sliderInput("theta", label = "Elasticity, tendendy of consumers to smooth their consumption over time:", min = 0, max = 1, value = 0.03, step = 0.01),
                 sliderInput("rho", label = "Rate at which consumers discount their future consumption", min = 0, max = 1, value = 0.2, step = 0.01),
                 sliderInput("delta", label = "Depreciation rate of capital", min = 0, max = 1, value = 0.1, step = 0.01),
                 sliderInput("alpha", label = "Elasticity parameter (measuring the responsiveness of the output production to changes in the input capital):", min = 0, max = 1, value = 0.3, step = 0.01),
                 
)    
```

Column
-----------------------------------------------------------------------


### Initial values {data-height=350}
```{r}
 
 ####################################################
#Conditional panel for initial values for Solow model#
 ####################################################
conditionalPanel("input.model == 'Solow'",
sliderInput("initial_values", label="initial values", min=1, max=5, value=1, step=1),
conditionalPanel("input.initial_values == 1",
                 numericInput('aa1', 'a', 1 )),
conditionalPanel("input.initial_values == 2",
                 fillRow(numericInput('aa2', 'a', 1),
                         numericInput('bb2', 'b', 1))),
conditionalPanel("input.initial_values == 3",
                 fillRow(numericInput('aa3', 'a', 1),
                         numericInput('bb3', 'b', 1),
                         numericInput('cc3', 'c', 1))),
conditionalPanel("input.initial_values == 4",
                 fillRow(
                   numericInput('aa4', 'a', 1),
                   numericInput('bb4', 'b', 1),
                   numericInput('cc4', 'c', 1),
                   numericInput('dd4', 'd', 1))
                 ),
                 
conditionalPanel("input.initial_values == 5",
                 fillRow(
                   numericInput('aa5', 'a', 1),
                   numericInput('bb5', 'b', 1),
                   numericInput('cc5', 'c', 1),
                   numericInput('dd5', 'd', 1),
                   numericInput('ee5', 'e', 1))
                 ),
actionButton("go","(Re)start Numeric Simulation", style="background-color: #ec7063 ; border-radius: 10px !important; border: none; position:absolute; bottom: 5px; margin: auto;"
))

 ######################################################
#Conditional panel for initial values for Goodwin model#
 #####################################################
#y0 <- matrix(c(0.2, 1, 0.6, 1, 1.1, 1), ncol = 2, nrow = 3, byrow = TRUE)
conditionalPanel("input.model == 'Goodwin'",
                 fluidPage(
                   fluidRow(
                     sliderInput("initial_values_g",
                                 label="initial values",
                                 min=1,
                                 max=3,
                                 value=1,
                                 step=1)
                     ),
                   fluidRow(
                     conditionalPanel("input.initial_values_g == 1",
                                      numericInput('gaa1', 'a', 0.2 ),
                                      numericInput('gbb1', 'b', 1)),
                     conditionalPanel("input.initial_values_g == 2",
                                      column(6,
                                             numericInput('gaa2', 'a1', 0.2),
                                             numericInput('gbb2', 'b1', 1)),
                                      column(6,
                                             numericInput('gcc2', 'a2',0.6),
                                             numericInput('gdd2', 'b2',1))),
                     conditionalPanel("input.initial_values_g == 3",
                                      column(4,
                                             numericInput('gaa3', 'a1', 0.2),
                                             numericInput('gbb3', 'b1', 1)),
                                      column(4,
                                             numericInput('gcc3', 'a2', 0.6),
                                             numericInput('gdd3', 'b2', 1)),
                                      column(4,
                                             numericInput('gee3', 'a3', 0.8),
                                             numericInput('gff3', 'b3', 1)))),
                   fluidRow(
                     actionButton("go2",
                                  "(Re)start Numeric Simulation", 
                                  style="background-color: #ec7063 ; border-radius: 10px !important; border: none; position:absolute; bottom: 5px; margin: auto;"))))

```





### Numerical Simulations

```{r}
 initial_val <- eventReactive(input$go, {
   print(typeof(input$initial_values))
   nval <- input$initial_values
   print(paste("nval=",nval))
   if(nval==1){return(c(input$aa1))} 
   else if (nval==2){return(c(input$aa2,input$bb2))}
   else if(nval==3){return(c(input$aa3,input$bb3,input$cc3))}
   else if(nval==4){return(c(input$aa4,input$bb4,input$cc4,input$dd4))}
   else {return(c(input$aa5,input$bb5,input$cc5,input$dd5,input$ee5))}
 
   # ifelse(nval==1, c(a),
   #        ifelse(nval==2, c(a,b),
   #               ifelse(nval==3, c(a,b,c), 
   #                      ifelse(nval==4, c(a,b,c,d), 
   #                             c(a,b,c,d,e)))))
   })
initial_val_g <- eventReactive(input$go2, {
  return(c(input$gaa2,input$gbb2))})
 
conditionalPanel("input.model == 'Solow'",
                 absolutePanel(
                        width = "100%", height = "100%",
                 renderPlot({
                   ini <- initial_val()
                   phaseR::flowField(solow_de,
                                     xlim   = c(0.0001, input$t),
                                     ylim   = c(0.0001, input$k),
                                     parameters = c(input$s,input$a,input$d),
                                     points=10,
                                     system = 'one.dim',
                                     add = F,
                                     xlab = 't',
                                     ylab = 'dk/dt')
                   phaseR::nullclines(solow_de,
                                      xlim   = c(0.0001, input$t),
                                      ylim <- c(0.0001,input$k),
                                      parameters = c(input$s,input$a,input$d),
                                      system = "one.dim",
                                      state.names = 'k')
                   phaseR::trajectory(solow_de,
                                      y0 = ini,
                                      tlim = c(0, input$t),
                                      parameters = c(input$s,input$a,input$d),
                                      system = "one.dim",
                                      add = T)})))

conditionalPanel("input.model == 'Goodwin'",
                 absolutePanel(
                        width = "100%", height = "100%",
                 renderPlot({
                   ini_g <- initial_val_g()
                   parameters <- c(a = 1.5,
                                   b = 1.8,
                                   c = 0.8,
                                   d = 0.8,
                                   sigma=0.8)
                   state <- c(V = ini_g[1], #0.5
                              U = ini_g[2], #1
                              Q = 1)
                   times <- seq(0, 20, by = 0.01)
                   out <- deSolve::ode(y = state, times = times, func = goodwin2, parms = parameters)
                   par(oma = c(0, 0, 3, 0))
                   plot(out, xlab = "time", ylab = "-")})))

conditionalPanel("input.model == 'Ramsey'",
                 absolutePanel(
                        width = "100%", height = "100%",
                        ((
                 renderPlot({
                   phaseR::flowField(
                     ramsey,
                     xlim = c(0.01,input$k),
                     ylim = c(0.01,input$c),
                     parameters = c(0.2,0.03,0.1,0.3),
                     points = 10,
                     add=F)
                   #grid()
                   phaseR::nullclines(
                     ramsey,
                     xlim = c(0,input$k),
                     ylim = c(0.01,input$c),
                     state.names = c('k','c'),
                     parameters = c(0.2,0.03,0.1,0.3),
                     points = 500,
                     col = c("blue","red"),
                     add.legend=T)})))))
```

Column {.tabset}
--------------------------------------------------------------------

### Dynamics

```{r}
#renderPrint(input$model)
#uiOutput("dynamic")
fluidPage(
conditionalPanel("input.model == 'Solow'",
                 absolutePanel(
                        width = "100%", height = "100%",
                        renderPlot({
                          k <- 1:input$k
                          ggplot()+
                            geom_line(aes(x = k, y = Solow1(input$s,k, input$a), color = "blue"))+
                            geom_line(aes(x=k,y=Solow2(input$d, k), color = "red"))+
                            theme_bw()
    #plot(k,Solow(input$s,k, input$a), type="l")
    #lines(k,Solow(input$s,k, -input$a), type="l")
    }))))
```

### Phase Portrait/Phase Diagram

```{r}
y_in <- eventReactive(input$go2, {
  print(input$initial_values_g)
  print(c(input$aa3, input$bb3, input$cc3, input$dd3, input$ee3, input$ff3))
  if(input$initial_values_g==1){
    return(matrix(c(input$gaa1, input$gbb1), ncol = 1, nrow = 2, byrow = TRUE))}
  else if(input$initial_values_g==2){
      return(matrix(c(input$gaa2, input$gbb2, input$gcc2, input$gdd2), ncol = 2, nrow = 2, byrow = TRUE))}
  else{return(matrix(c(input$gaa3, input$gbb3, input$gcc3, input$gdd3, input$gee3, input$gff3), ncol = 3, nrow = 2, byrow = TRUE))}})

conditionalPanel("input.model == 'Solow'",
                 absolutePanel(
                        width = "100%", height = "100%",
                 renderPlot({
                   phaseR::phasePortrait(solow_de,
                                         ylim <- c(0.5,input$k),
                                         parameters = c(input$s,input$a,input$d),
                                         col = 'black',
                                         add.grid = T,
                                         xlab='k',
                                         ylab='dk/dt')})))

conditionalPanel("input.model == 'Goodwin'",
                 absolutePanel(
                        width = "100%", height = "100%",
                 renderPlot({
                   y0 <- y_in()
                   phaseR::flowField(goodwin,
                                      xlim = c(0,1.5), 
                                      ylim = c(0, 1.5), 
                                      parameters = c(0.25, 0.6, 0.2, 0.3, 0.4), 
                                      points = 19, 
                                      add = FALSE,
                                      xlab = "a",
                                      ylab = "b")
                   phaseR::nullclines(goodwin,
                                      xlim = c(0,1.5), 
                                      ylim = c(0, 1.5),
                                      parameters = c(0.25, 0.6, 0.2, 0.3, 0.4), 
                                      points = 500)
                   phaseR::trajectory(goodwin, 
                                      y0 = y0, 
                                      tlim = c(0,10),
                                      parameters = c(0.25, 0.6, 0.2, 0.3, 0.4), 
                                      colour = rep("black", 3))})))
```



PhaseR and Our Tool{data-navmenu='About this Project' data-icon="ion-cube"} 
========================================================================

Link and short presentation of the package and the paper associated. 

Future Perspectives{data-navmenu='About this Project' data-icon='ion-ios-paperplane-outline'} 
========================================================================

Possibility of a package, extending/generalizing the tool to all macro 1-ODE and 2-ODE...

Resources{data-navmenu='Models' data-icon='ion-merge'}
========================================================================

In that page we can propose short econ/math developments on the models and/or links to the papers and teaching courses
